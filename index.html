<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>一括画像リサイズ & 圧縮｜比率切替＋再変換対応</title>
<meta name="description" content="ドラッグ&ドロップで画像を一括リサイズ・圧縮。アスペクト比維持 / 16:9 / 9:16 切替、再変換ボタンで設定変更後も即再処理。完全クライアントサイド。">
<style>
  :root { --bg:#0f1220; --card:#161a2b; --text:#e8ecf1; --muted:#a8b3c7;
          --accent:#7cd1ff; --accent-2:#8affc1; --danger:#ff6b6b;
          --keep:#8a8fa3; --r169:#6fb4ff; --r916:#6fffc3; }
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0;
    background:linear-gradient(180deg,#0f1220,#0d1020 60%,#0f1220); color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Sans","Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Segoe UI Symbol",sans-serif;}
  header{ padding:28px 16px 8px; text-align:center; }
  header h1{ font-size:22px; margin:0 0 6px; letter-spacing:.03em; }
  header p{ margin:0; color:var(--muted); font-size:13px; }
  .container{ max-width:980px; margin:0 auto; padding:16px; }
  .panel{ background:linear-gradient(180deg, rgba(124,209,255,.06), rgba(138,255,193,.06));
    border:1px solid rgba(124,209,255,.2); border-radius:14px; padding:16px; margin-bottom:14px; }
  .grid{ display:grid; gap:14px; grid-template-columns:repeat(12,1fr); }
  .col-12{ grid-column:span 12; } .col-6{ grid-column:span 6; } .col-4{ grid-column:span 4; }
  @media (max-width:760px){ .col-6,.col-4{ grid-column:span 12; } }
  label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
  input[type="number"], select{ width:100%; background:var(--card); color:var(--text);
    border:1px solid rgba(124,209,255,.25); padding:10px 12px; border-radius:10px; outline:none; }
  input[type="range"]{ width:100%; }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .btn{ background:linear-gradient(180deg, rgba(124,209,255,.18), rgba(124,209,255,.12));
    color:var(--text); border:1px solid rgba(124,209,255,.35);
    padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; letter-spacing:.02em;
    text-decoration:none; display:inline-block; }
  .btn:hover{ border-color:rgba(138,255,193,.6); }
  .btn.danger{ border-color:rgba(255,107,107,.5); background:rgba(255,107,107,.15); }
  .hint{ font-size:12px; color:var(--muted); }
  .dropzone{ border:1.5px dashed rgba(124,209,255,.4); background:rgba(12,16,34,.8);
    border-radius:14px; padding:18px; text-align:center; transition:.15s border-color ease; }
  .dropzone.dragover{ border-color:var(--accent-2); background:rgba(14,24,50,.9); }
  .gallery{ display:grid; gap:12px; grid-template-columns:repeat(auto-fill, minmax(180px,1fr)); }
  .card{ background:var(--card); border:1px solid rgba(124,209,255,.2); border-radius:12px; overflow:hidden; }
  .card.keep{ border-color:rgba(138,143,163,.6); }
  .card.r169{ border-color:rgba(111,180,255,.75); }
  .card.r916{ border-color:rgba(111,255,195,.75); }
  .card img{ width:100%; display:block; background:#0b0e1a; }
  .card .meta{ padding:10px; font-size:12px; color:var(--muted); }
  .badge{ display:inline-flex; align-items:center; gap:6px; padding:2px 8px; font-size:11px;
    border-radius:99px; border:1px solid rgba(124,209,255,.35); color:var(--text); }
  .badge.keep{ border-color:var(--keep); }
  .badge.r169{ border-color:var(--r169); }
  .badge.r916{ border-color:var(--r916); }
  .footer{ text-align:center; font-size:12px; color:var(--muted); padding:16px 8px 32px; }
  .progress{ height:8px; border-radius:99px; background:rgba(255,255,255,.06); overflow:hidden; }
  .progress>div{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); transition:width .2s ease; }
</style>
</head>
<body>
<header>
  <h1>一括画像リサイズ & 圧縮 <small style="font-size:12px; color:var(--muted);">｜ 比率切替 + 再変換</small></h1>
  <p>ドラッグ&ドロップで画像をまとめて変換。ブラウザ内で完結（外部送信なし）。</p>
</header>

<div class="container">
  <div class="panel">
    <div class="grid">
      <div class="col-4">
        <label>最大幅（px）</label>
        <input type="number" id="maxWidth" value="1080" min="64" step="1">
      </div>
      <div class="col-4">
        <label>最大高（px）</label>
        <input type="number" id="maxHeight" value="1920" min="64" step="1">
      </div>
      <div class="col-4">
        <label>出力フォーマット</label>
        <select id="format">
          <option value="image/webp">WebP（小さい）</option>
          <option value="image/jpeg">JPEG</option>
          <option value="image/png">PNG</option>
        </select>
      </div>
      <div class="col-12">
        <label>画質（JPEG/WebPのみ） <span id="qLabel" class="hint">0.8</span></label>
        <input type="range" id="quality" min="0.1" max="1" step="0.05" value="0.8">
      </div>
      <div class="col-12">
        <label>比率設定</label>
        <div class="row">
          <label class="badge keep"><input type="radio" name="ratio" value="keep" checked> 比率維持</label>
          <label class="badge r169"><input type="radio" name="ratio" value="16:9"> 16:9 固定（トリミング）</label>
          <label class="badge r916"><input type="radio" name="ratio" value="9:16"> 9:16 固定（トリミング）</label>
        </div>
        <div class="hint" style="margin-top:6px;">※ 固定比率は余白を作らず、<b>余分をトリミング</b>して合わせます。</div>
      </div>
      <div class="col-12 row">
        <input type="file" id="fileInput" multiple accept="image/*" style="display:none;" />
        <button class="btn" id="pickBtn">画像を選ぶ</button>
        <button class="btn danger" id="clearBtn">リセット</button>
        <span class="hint">ヒント：9:16（1080×1920）や16:9（1920×1080）などに一括調整できます。</span>
      </div>
    </div>
  </div>

  <div class="panel dropzone" id="dropzone">
    <strong>ここに画像をドラッグ&ドロップ</strong><br/>
    または「画像を選ぶ」ボタンを使ってください。
  </div>

  <div class="panel">
    <div class="row" style="justify-content: space-between;">
      <div class="row" style="gap:8px; align-items:center;">
        <button class="btn" id="reprocessBtn">再変換する</button>
        <span class="hint">※ 設定を変えたら押すと、読み込んだ画像をまとめて再処理します。</span>
      </div>
      <button class="btn" id="downloadAllBtn">すべてダウンロード</button>
    </div>
    <div class="progress" style="margin-top:10px;"><div id="bar"></div></div>
  </div>

  <div class="gallery" id="gallery"></div>
</div>

<div class="footer">
  <div>ブラウザ内で処理するため、画像はネットにアップロードされません。</div>
  <div style="margin-top:6px;">© 2025 QuickTools</div>
</div>

<script>
(function(){
  const maxWidthEl = document.getElementById('maxWidth');
  const maxHeightEl = document.getElementById('maxHeight');
  const formatEl = document.getElementById('format');
  const qualityEl = document.getElementById('quality');
  const qLabel = document.getElementById('qLabel');
  const fileInput = document.getElementById('fileInput');
  const pickBtn = document.getElementById('pickBtn');
  const clearBtn = document.getElementById('clearBtn');
  const dropzone = document.getElementById('dropzone');
  const gallery = document.getElementById('gallery');
  const downloadAllBtn = document.getElementById('downloadAllBtn');
  const reprocessBtn = document.getElementById('reprocessBtn');
  const bar = document.getElementById('bar');
  const ratioRadios = document.querySelectorAll('input[name="ratio"]');

  // 元画像の保持（再変換用）
  let originals = []; // [{file: File, name: string}]
  let results = [];   // [{blob, name, w, h, size, mode}]

  qualityEl.addEventListener('input', ()=> qLabel.textContent = qualityEl.value);
  pickBtn.addEventListener('click', ()=> fileInput.click());
  clearBtn.addEventListener('click', ()=> { originals=[]; results=[]; gallery.innerHTML=''; bar.style.width='0%'; });
  fileInput.addEventListener('change', (e)=> handleFiles(e.target.files));

  ['dragenter','dragover'].forEach(ev=> dropzone.addEventListener(ev, e=>{
    e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover');
  }));
  ['dragleave','drop'].forEach(ev=> dropzone.addEventListener(ev, e=>{
    e.preventDefault(); e.stopPropagation();
    if (ev === 'drop') handleFiles(e.dataTransfer.files);
    dropzone.classList.remove('dragover');
  }));

  function getSelectedRatio(){
    const v = Array.from(ratioRadios).find(r=>r.checked)?.value || 'keep';
    if (v === 'keep') return {mode:'keep', label:'比率維持'};
    if (v === '16:9') return {mode:'fixed', ar: 16/9, label:'16:9 固定'};
    if (v === '9:16') return {mode:'fixed', ar: 9/16, label:'9:16 固定'};
    return {mode:'keep', label:'比率維持'};
  }

  async function handleFiles(fileList){
    const files = Array.from(fileList).filter(f => f.type.startsWith('image/'));
    if (!files.length) return;
    originals.push(...files.map(f => ({file:f, name:f.name})));
    await processAndRenderAll(files);
  }

  async function processAndRenderAll(files){
    const total = files.length;
    let done = 0;
    for (const f of files){
      try{
        const out = await processImageFile(f, getSelectedRatio());
        results.push(out); addCard(out);
      }catch(err){ console.error('convert error', err); }
      finally{ done++; bar.style.width = Math.round(done/total*100)+'%'; }
    }
  }

  reprocessBtn.addEventListener('click', async ()=>{
    if (!originals.length) return;
    // 画面をクリアして再処理
    results = [];
    gallery.innerHTML = '';
    bar.style.width = '0%';
    const files = originals.map(o => o.file);
    await processAndRenderAll(files);
  });

  function loadImageFromFile(file){
    return new Promise((resolve, reject)=>{
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = ()=>{ URL.revokeObjectURL(url); resolve(img); };
      img.onerror = reject; img.src = url;
    });
  }

  async function processImageFile(file, ratioSetting){
    const img = await loadImageFromFile(file);
    const maxW = Math.max(64, parseInt(maxWidthEl.value || '1080', 10));
    const maxH = Math.max(64, parseInt(maxHeightEl.value || '1920', 10));
    const fmt = formatEl.value;
    const q = parseFloat(qualityEl.value || '0.8');

    let srcX = 0, srcY = 0, srcW = img.width, srcH = img.height;
    let targetW, targetH;
    let modeClass = 'keep'; // for UI border color
    let ratioLabel = '比率維持';

    if (ratioSetting.mode === 'keep'){
      const scale = Math.min(maxW / img.width, maxH / img.height, 1);
      targetW = Math.round(img.width * scale);
      targetH = Math.round(img.height * scale);
      modeClass = 'keep'; ratioLabel = '比率維持';
    } else {
      const targetAR = ratioSetting.ar; // 16/9 or 9/16
      const srcAR = img.width / img.height;
      if (srcAR > targetAR){
        const newW = Math.round(img.height * targetAR);
        srcX = Math.floor((img.width - newW) / 2); srcW = newW;
      } else if (srcAR < targetAR){
        const newH = Math.round(img.width / targetAR);
        srcY = Math.floor((img.height - newH) / 2); srcH = newH;
      }
      const scaleByW = maxW / srcW;
      const scaleByH = maxH / srcH;
      const scale = Math.min(scaleByW, scaleByH, 1);
      targetW = Math.round(srcW * scale);
      targetH = Math.round(srcH * scale);
      // decide class & label
      modeClass = (Math.abs(targetAR - 16/9) < Math.abs(targetAR - 9/16)) ? 'r169' : 'r916';
      ratioLabel = (modeClass === 'r169') ? '16:9 固定' : '9:16 固定';
    }

    const canvas = document.createElement('canvas');
    canvas.width = targetW; canvas.height = targetH;
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(img, srcX, srcY, srcW, srcH, 0, 0, targetW, targetH);

    const blob = await new Promise(resolve => {
      if (fmt === 'image/png') canvas.toBlob(resolve, 'image/png');
      else if (fmt === 'image/webp') canvas.toBlob(resolve, 'image/webp', q);
      else canvas.toBlob(resolve, 'image/jpeg', q);
    });

    const base = (file.name || 'image').replace(/\.[^.]+$/, '');
    const ext = fmt === 'image/png' ? 'png' : (fmt === 'image/webp' ? 'webp' : 'jpg');
    const name = `${base}-${targetW}x${targetH}.${ext}`;

    return { blob, name, w: targetW, h: targetH, size: blob ? blob.size : 0, mode: modeClass, ratioLabel };
  }

  function addCard({blob, name, w, h, size, mode}){
    const url = URL.createObjectURL(blob);
    const card = document.createElement('div'); card.className='card ' + (mode||'keep');
    const ratioBadgeClass = mode || 'keep';
    const ratioText = (mode==='r169') ? '16:9 固定' : (mode==='r916') ? '9:16 固定' : '比率維持';
    card.innerHTML = `
      <img src="${url}" alt="${name}" />
      <div class="meta">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
          <span class="badge ${ratioBadgeClass}">${w}×${h} ・ ${ratioText}</span>
          <a class="btn" download="${name}" href="${url}">ダウンロード</a>
        </div>
        <div class="hint" style="margin-top:6px;">${name} ・ ${formatBytes(size)}</div>
      </div>`;
    gallery.prepend(card);
  }

  function formatBytes(bytes){
    if (bytes == null) return '-';
    const k=1024, sizes=['B','KB','MB','GB']; const i=Math.floor(Math.log(bytes)/Math.log(k));
    return (bytes/Math.pow(k,i)).toFixed(2)+' '+sizes[i];
  }

  downloadAllBtn.addEventListener('click', async ()=>{
    if (!results.length) return;
    for (const r of results){
      const a=document.createElement('a'); const url=URL.createObjectURL(r.blob);
      a.href=url; a.download=r.name; document.body.appendChild(a); a.click(); a.remove();
      await new Promise(res=> setTimeout(res, 80)); URL.revokeObjectURL(url);
    }
  });
})();
</script>
</body>
</html>
